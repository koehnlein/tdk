---
# Example
# 8.1 https://gitpod.io/#TDK_PHP_VERSION=8.1,TDK_BRANCH=main,TDK_PATCH_REF=refs%2Fchanges%2F43%2F70643%2F36,TDK_USERNAME=ochorocho,TDK_PATCH_ID=70643/https://github.com/ochorocho/tdk/tree/task/gitpod-optimize
# 8.0 https://gitpod.io/#TDK_PHP_VERSION=8.0,TDK_BRANCH=main,TDK_PATCH_REF=refs%2Fchanges%2F43%2F70643%2F36,TDK_USERNAME=ochorocho,TDK_PATCH_ID=70643/https://github.com/ochorocho/tdk/tree/task/gitpod-optimize
# Detect php: https://gitpod.io/#TDK_BRANCH=11.5,TDK_PATCH_REF=refs%2Fchanges%2F43%2F70643%2F36,TDK_USERNAME=ochorocho,TDK_PATCH_ID=70643/https://github.com/ochorocho/tdk/tree/task/gitpod-optimize
image: ochorocho/gitpod-tdk:latest
# !!!! Check path mapping for sysext (works), ext and packages!

tasks:
  - name: TDK
    # Installing sqltools manually to avoid the reload message on start.
    # vscode:extensions does not work for some reason
     init: |
      gitpod-code --install-extension mtxr.sqltools mtxr.sqltools-driver-mysql 
      mkdir -p .vscode
      cp -Rp .gitpod/vscode/settings.json .vscode/settings.json
      cp -Rp .gitpod/vscode/launch.json .vscode/launch.json
      tdk php "$(php .gitpod/php/version.php)" --no-reload
      gp open .gitpod/info.md
      composer tdk:clone
      composer tdk:checkout
      composer install
      composer tdk:set-git-config
      composer tdk:enable-hooks -- --force
      composer tdk:apply-patch
      mkdir -p public/typo3conf
      touch public/FIRST_INSTALL
      cp -Rp .gitpod/typo3/AdditionalConfiguration.php public/typo3conf/AdditionalConfiguration.php
    command: |
      tdk php "$(php .gitpod/php/version.php)"
      sudo service mailhog start
      sudo service mysql start
      sudo service cron start
      sleep 5
      tdk db create
      composer tdk:help
      tdk preview fe
      gp sync-done tdk-done

# VScode xdebug extension
vscode:
  extensions:
    - felixfbecker.php-debug
    - wongjn.php-sniffer
    - neilbrayfield.php-docblocker
    - bmewburn.vscode-intelephense-client
    - mtxr.sqltools
    - mtxr.sqltools-driver-mysql

ports:
  - port: 3306
    name: database
    onOpen: ignore
  - port: 8001
    name: apache
    onOpen: ignore
  - port: 1025
    name: mailhog catcher
    onOpen: ignore
  - port: 8025
    name: mailhog
    onOpen: ignore
  - port: 9003
    name: xdebug
    description: xdebug
    onOpen: ignore
